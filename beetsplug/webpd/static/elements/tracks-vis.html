<link rel="import" href="../bower_components/polymer/polymer.html">

<polymer-element name="tracks-vis" attributes="artist tracks xMapping yMapping">
<template>
  <style>
    tracks-vis ^ #render {
      width: 100%;
      height: 100%;
    }
  </style>
  <svg id="render"></svg>
</template>
<script>
/**
 * Visualize tracks mainly horizontally in an x,y coordinate-space.
 */
Polymer('tracks-vis', {
  artist: null,
  tracks: null,
  xMapping: 'danceability',
  yMapping: 'valence',
  // This guard was introduced because of life-cycle issues relating to an
  // attempt to cause us to render ourselves after we were already detached
  // from the DOM or in the process of being detached from the DOM.  Because
  // of the micro-task magic that is used and how the virtual-list works, I
  // expect we do not actually need this guard or the related logic for
  // startup purposes.  But I can't claim to understand things sufficiently
  // right now that it makes sense to risk removing this and shooting myself
  // in the foot.
  //
  // NB: The life-cycle thing is likely a result of our use of promises and
  // high rates of scrolling which can cause the virtual list to destroy things
  // rather quickly
  _ready: false,
  
  domReady: function() {
    this._ready = true;
    if (this.tracks) {
      this.render();
    }
  },
  detached: function() {
    this._ready = false;
  },
  artistChanged: function() {
    this.artist.ensureAllTracks().then(function(tracks) {
      this.tracks = tracks;
    }.bind(this), function(err) {
      console.warn('Problem fetching tracks');
    });
  },
  tracksChanged: function() {
    if (this._ready) {
      this.render();
    }
  },
  render: function() {
    var tracks = this.tracks;
    if (!tracks || !this._ready) {
      return;
    }
    var svg = d3.select(this.$.render);

    var padding = 4;

    var width = parseInt(svg.style("width")) - padding;
    var height = parseInt(svg.style("height")) - padding;

    if (isNaN(width)) {
      // isNaN means the style resolution failed which means we were removed
      // from the DOM tree.  There is no need to reschedule ourselves because
      // we're dead.  Just return.
      return;
    }

    var xProp = this.xMapping;
    var x = d3.scale.linear()
      .domain([0, 1])
      .range([padding, padding + width - 1])
      .clamp(true);

    var yProp = this.yMapping;
    var y = d3.scale.linear()
      .domain([0, 1])
      .range([padding, padding + height - 1])
      .clamp(true);

    var color = d3.scale.ordinal()
      .domain(['album', 'single', 'compilation'])
      .range(['red', 'green', 'blue']);

    function normNum(val) {
      if (val == null) {
        return 0;
      }
      var floatVal = parseFloat(val);
      return floatVal;
    }

    var trackadots = svg.selectAll('.track')
        .data(tracks.models)
      .enter().append('circle')
        .attr('class', 'track')
        .attr('r', 2)
        .attr('cx', function(track) { return x(normNum(track.get(xProp))); })
        .attr('cy', function(track) { return y(normNum(track.get(yProp))); })
        .attr('fill', function(track) {
                        return color(track.get('normalbumtype'));
                      })
        .attr('fill-opacity', 0.2)
  }
});
</script>
</polymer-element>
